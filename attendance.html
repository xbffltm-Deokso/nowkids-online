<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>출석체크</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <h2 id="pageTitle">출석체크</h2>
        <div class="date-display" id="todayDate"></div>

        <!-- 로딩 스피너 -->
        <div id="loadingSpinner" class="spinner-container">
            <div class="spinner"></div>
        </div>

        <!-- 학생 명단 리스트 -->
        <form id="attendanceForm" class="hidden">
            <div class="message" style="font-size: 1rem; margin: 10px 0; text-align: left;">
                출석한 학생을 모두 선택하세요.
            </div>

            <ul id="studentList" class="student-list">
                <!-- JS로 리스트 아이템 생성 -->
            </ul>

            <div style="margin-top: 20px;">
                <button type="submit" id="submitBtn">출석 제출하기</button>
                <button type="button" class="secondary" onclick="history.back()">뒤로가기</button>
            </div>
        </form>

        <!-- 에러 메시지 표시용 -->
        <div id="errorMessage" class="message" style="color: var(--error-color); display: none;"></div>
    </div>

    <script src="config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. URL 파라미터 파싱
            const urlParams = new URLSearchParams(window.location.search);
            const grade = urlParams.get('grade');
            const cls = urlParams.get('class');

            // 파라미터 검증
            if (!grade || !cls) {
                alert('잘못된 접근입니다. 메인 페이지로 이동합니다.');
                window.location.href = 'index.html';
                return;
            }

            // UI 초기화
            document.getElementById('pageTitle').textContent = `${grade} ${cls}반 출석체크`;

            // 날짜 표시 (기준 일요일)
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day;
            const targetSunday = new Date(today.setDate(diff));

            document.getElementById('todayDate').textContent = targetSunday.toLocaleDateString('ko-KR', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            });

            // 2. 학생 명단 가져오기 (doGet)
            fetchStudents(grade, cls);

            // 3. 폼 제출 처리
            document.getElementById('attendanceForm').addEventListener('submit', (e) => {
                e.preventDefault();
                submitAttendance(grade, cls);
            });
        });

        async function fetchStudents(grade, cls) {
            const spinner = document.getElementById('loadingSpinner');
            const form = document.getElementById('attendanceForm');
            const errorMsg = document.getElementById('errorMessage');

            spinner.style.display = 'flex';
            form.classList.add('hidden');
            errorMsg.style.display = 'none';

            try {
                // API 호출
                const response = await fetch(`${API_URL}?grade=${grade}&class=${cls}`);
                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }

                renderStudentList(result.data);
                spinner.style.display = 'none';
                form.classList.remove('hidden');

            } catch (error) {
                console.error('Error fetching students:', error);
                spinner.style.display = 'none';
                errorMsg.textContent = '학생 명단을 불러오는데 실패했습니다. ' + error.message;
                errorMsg.style.display = 'block';
            }
        }

        function renderStudentList(students) {
            const listContainer = document.getElementById('studentList');
            listContainer.innerHTML = '';

            if (!students || students.length === 0) {
                listContainer.innerHTML = '<li class="message">등록된 학생이 없습니다.</li>';
                document.getElementById('submitBtn').disabled = true;
                return;
            }

            students.forEach(student => {
                const li = document.createElement('li');
                li.className = 'student-item';

                // 체크박스 ID 생성 (고유해야 함)
                const checkboxId = `student_${student.name}`;

                li.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" name="student" value="${student.name}">
                    <label for="${checkboxId}">${student.name}</label>
                `;
                listContainer.appendChild(li);
            });
        }

        async function submitAttendance(grade, cls) {
            const submitBtn = document.getElementById('submitBtn');
            const originalBtnText = submitBtn.textContent;

            // 선택된 학생 수집
            const checkboxes = document.querySelectorAll('input[name="student"]:checked');
            const selectedStudents = Array.from(checkboxes).map(cb => cb.value);

            if (selectedStudents.length === 0) {
                if (!confirm('선택된 학생이 없습니다. 그래도 제출하시겠습니까? (결석 처리됨)')) {
                    return;
                }
            }

            // 버튼 비활성화 및 로딩 표시
            submitBtn.disabled = true;
            submitBtn.textContent = '제출 중...';

            try {
                // doPost 호출
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        grade: grade,
                        class: cls,
                        students: selectedStudents
                    })
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = 'success.html';
                } else {
                    throw new Error(result.error || '알 수 없는 오류');
                }

            } catch (error) {
                console.error('Error submitting attendance:', error);
                alert('제출 중 오류가 발생했습니다: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        }
    </script>
</body>

</html>